import re, speech_recognition as sr

stopped = False  # ‡∏ò‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô

r = sr.Recognizer()
with sr.Microphone() as mic:
    r.adjust_for_ambient_noise(mic, duration=0.6)
    print("‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤ '‡∏´‡∏¢‡∏∏‡∏î' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î | '‡πÄ‡∏£‡∏¥‡πà‡∏°' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠ | '‡∏≠‡∏≠‡∏Å' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î")
    print("‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏´‡∏°‡∏∏‡∏ô‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÑ‡∏õ‡∏ó‡∏µ‡πà 90 ‡∏≠‡∏á‡∏®‡∏≤'")

    while True:
        try:
            audio = r.listen(mic, timeout=6, phrase_time_limit=10)
            text = r.recognize_google(audio, language="th-TH").strip()
            print("‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô :", text)

            # ===== ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏´‡∏°‡∏î =====
            if "‡∏≠‡∏≠‡∏Å" in text or "‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°" in text:
                print("‡∏à‡∏ö‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô üëã")
                break

            if "‡∏´‡∏¢‡∏∏‡∏î" in text or "stop" in text.lower():
                stopped = True
                print("**‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß**")
                # TODO: ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏õ ESP32)
                continue

            if "‡πÄ‡∏£‡∏¥‡πà‡∏°" in text or "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠" in text or "start" in text.lower():
                stopped = False
                print("**‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß**")
                # TODO: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
                continue

            # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏¢‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô
            if stopped:
                print("(‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà) ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤ '‡πÄ‡∏£‡∏¥‡πà‡∏°'")
                continue

            # ===== ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏°: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ' ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏°‡∏∏‡∏° =====
            if text.startswith("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ"):
                cmd = text.replace("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ", "", 1).strip()
                m = re.search(r"(\d+)", cmd)
                angle = int(m.group(1)) if m else None
                print("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ : ", cmd, " | ‡∏°‡∏∏‡∏° : ", angle)

                # TODO: ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏™‡πà‡∏á angle ‡πÑ‡∏õ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                # ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á Serial: "ANGLE <‡∏Ñ‡πà‡∏≤>"

        except sr.WaitTimeoutError:
            print("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞")
        except sr.UnknownValueError:
            print("‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏£‡∏û‡∏π‡∏î‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞.....")
        except Exception as e:
            print("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", e)
    